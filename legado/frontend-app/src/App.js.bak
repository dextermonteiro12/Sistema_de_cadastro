import React, { useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Link } from 'react-router-dom';

import Home from './screens/home';
import Clientes from './screens/Clientes';
import Movimentacoes from './screens/Movimentacoes';
import Monitoramento from './screens/Monitoramento';
import Normalizacao from './screens/Normalizacao';
import Configuracao from './screens/Configuracao';
import CargaCoTit from './screens/Cargacotit';

import { ConfigProvider, useConfig } from './context/ConfigContext';
import './App.css';

const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:5000';

// ===== ESTILOS =====
const navStyle = { 
  background: '#20232a', 
  padding: '15px', 
  display: 'flex', 
  gap: '20px', 
  justifyContent: 'center', 
  borderRadius: '8px', 
  marginBottom: '20px',
  flexWrap: 'wrap',
  alignItems: 'center'
};

const linkNav = { 
  color: 'white', 
  textDecoration: 'none', 
  fontSize: '14px', 
  fontWeight: 'bold',
  cursor: 'pointer'
};

const statusIndicator = (status) => ({
  display: 'inline-block',
  width: '12px',
  height: '12px',
  borderRadius: '50%',
  backgroundColor: status === 'conectado' ? '#10b981' : '#ef4444',
  marginRight: '5px'
});

const btnLogout = { 
  background: '#ff4d4d', 
  color: 'white', 
  border: 'none', 
  padding: '5px 12px', 
  borderRadius: '4px', 
  cursor: 'pointer',
  fontSize: '12px'
};

const authContainerStyle = { 
  display: 'flex', 
  justifyContent: 'center', 
  alignItems: 'center', 
  height: '100vh', 
  backgroundColor: '#20232a' 
};

const authBoxStyle = { 
  backgroundColor: 'white', 
  padding: '40px', 
  borderRadius: '10px', 
  textAlign: 'center',
  maxWidth: '400px'
};

const inputStyle = { 
  width: '100%', 
  padding: '10px', 
  margin: '5px 0', 
  borderRadius: '4px', 
  border: '1px solid #ddd',
  boxSizing: 'border-box'
};

const btnSubmitStyle = { 
  ...inputStyle, 
  backgroundColor: '#007bff', 
  color: 'white', 
  cursor: 'pointer', 
  fontWeight: 'bold'
};

// ===== COMPONENTE LOGIN =====
const AuthSystem = ({ onLogin, carregando }) => {
  const [user, setUser] = useState('');
  const [pass, setPass] = useState('');

  return (
    <div style={authContainerStyle}>
      <div style={authBoxStyle}>
        <h2 style={{ color: '#333', marginBottom: '20px' }}>
          ğŸš€ Gerador Ãgil PLD v2.0
        </h2>
        <form onSubmit={(e) => { e.preventDefault(); onLogin(user, pass); }}>
          <input
            type="text"
            placeholder="UsuÃ¡rio"
            value={user}
            onChange={(e) => setUser(e.target.value)}
            style={inputStyle}
            required
          />
          <input
            type="password"
            placeholder="Senha"
            value={pass}
            onChange={(e) => setPass(e.target.value)}
            style={inputStyle}
            required
          />
          <button
            type="submit"
            style={btnSubmitStyle}
            disabled={carregando}
          >
            {carregando ? 'âŒ› Entrando...' : 'Entrar'}
          </button>
        </form>
      </div>
    </div>
  );
};

// ===== COMPONENTE NAVBAR COM STATUS =====
function NavBar({ userTipo, onLogout }) {
  const { configKey, config, status } = useConfig();

  return (
    <nav style={navStyle}>
      <Link to="/" style={linkNav}>ğŸ  InÃ­cio</Link>
      <Link to="/configuracao" style={linkNav}>âš™ï¸ Config</Link>
      <Link to="/clientes" style={linkNav}>ğŸ‘¥ Clientes</Link>
      <Link to="/Cargacotit" style={linkNav}>ğŸ‘¶ Dependentes</Link>
      <Link to="/movimentacoes" style={linkNav}>ğŸ’° MovimentaÃ§Ãµes</Link>
      <Link to="/normalizacao" style={linkNav}>ğŸ›¡ï¸ NormalizaÃ§Ã£o</Link>
      <Link to="/monitoramento" style={linkNav}>ğŸ“Š Monitoramento</Link>

      <div style={{ marginLeft: 'auto', display: 'flex', gap: '15px', alignItems: 'center' }}>
        <div style={{ fontSize: '12px', color: '#aaa', display: 'flex', alignItems: 'center', gap: '5px' }}>
          <span style={statusIndicator(status)}></span>
          {status === 'conectado' ? (
            <span>âœ“ {config?.usuario}@{config?.servidor?.split('\\')[0]}</span>
          ) : (
            <span>âœ— Sem conexÃ£o</span>
          )}
        </div>
        <button onClick={onLogout} style={btnLogout}>
          Sair
        </button>
      </div>
    </nav>
  );
}

// ===== COMPONENTE PRINCIPAL =====
function AppContent() {
  const [autenticado, setAutenticado] = useState(false);
  const [userTipo, setUserTipo] = useState('VISUALIZADOR');
  const [carregando, setCarregando] = useState(false);

  useEffect(() => {
    if (localStorage.getItem('pld_autenticado') === 'true') {
      setAutenticado(true);
      setUserTipo(localStorage.getItem('pld_tipo') || 'VISUALIZADOR');
    }
  }, []);

  const handleLogin = async (usuario, senha) => {
    setCarregando(true);
    try {
      const response = await fetch(`${API_BASE_URL}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: usuario, password: senha })
      });

      const data = await response.json();

      if (response.ok) {
        setAutenticado(true);
        setUserTipo(data.tipo);
        localStorage.setItem('pld_autenticado', 'true');
        localStorage.setItem('pld_tipo', data.tipo);
      } else {
        alert('âŒ ' + (data.message || 'Erro ao fazer login'));
      }
    } catch (e) {
      alert('âŒ Erro ao conectar com API');
    } finally {
      setCarregando(false);
    }
  };

  const handleLogout = () => {
    localStorage.clear();
    setAutenticado(false);
    window.location.reload();
  };

  if (!autenticado) {
    return <AuthSystem onLogin={handleLogin} carregando={carregando} />;
  }

  return (
    <Router>
      <div style={{ padding: '20px' }}>
        <NavBar userTipo={userTipo} onLogout={handleLogout} />

        <Routes>
          <Route path="/" element={<Home userTipo={userTipo} />} />
          <Route path="/configuracao" element={<Configuracao />} />
          <Route path="/clientes" element={<Clientes />} />
          <Route path="/Cargacotit" element={<CargaCoTit />} />
          <Route path="/movimentacoes" element={<Movimentacoes />} />
          <Route path="/normalizacao" element={<Normalizacao />} />
          <Route path="/monitoramento" element={<Monitoramento />} />
        </Routes>
      </div>
    </Router>
  );
}

// ===== APP WRAPPER COM CONTEXT =====
export default function App() {
  return (
    <ConfigProvider>
      <AppContent />
    </ConfigProvider>
  );
}
