import React, { useState } from 'react';
import { useConfig } from '../context/ConfigContext';

const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:5000';

export default function Configuracao() {
  const { configKey, config, status, carregando, erro, validarConfig, testarConexao, desconectar } = useConfig();

  const [formData, setFormData] = useState({
    servidor: config?.servidor || '',
    banco: config?.banco || '',
    usuario: config?.usuario || '',
    senha: config?.senha || ''
  });

  const [testando, setTestando] = useState(false);
  const [statusTeste, setStatusTeste] = useState(null);

  // Handle form change
  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Validar configura√ß√£o
  const handleValidar = async (e) => {
    e.preventDefault();
    
    if (!formData.servidor || !formData.banco || !formData.usuario || !formData.senha) {
      alert('‚ö†Ô∏è Preencha todos os campos');
      return;
    }

    const resultado = await validarConfig(formData);
    
    if (resultado.sucesso) {
      alert(`‚úÖ Configura√ß√£o ativada com sucesso!\nVers√£o: ${resultado.detalhes.versao_sistema}`);
    } else {
      alert(`‚ùå Erro: ${resultado.erro}`);
    }
  };

  // Apenas testar conex√£o
  const handleTestar = async () => {
    if (!formData.servidor || !formData.banco || !formData.usuario || !formData.senha) {
      alert('‚ö†Ô∏è Preencha todos os campos');
      return;
    }

    setTestando(true);
    setStatusTeste(null);

    try {
      const resultado = await testarConexao(formData);
      setStatusTeste(resultado);
    } finally {
      setTestando(false);
    }
  };

  // Desconectar
  const handleDesconectar = async () => {
    if (window.confirm('Tem certeza que deseja desconectar?')) {
      await desconectar();
      setFormData({ servidor: '', banco: '', usuario: '', senha: '' });
      alert('‚úì Desconectado');
    }
  };

  return (
    <div style={containerStyle}>
      <h2>‚öôÔ∏è Configura√ß√£o de Banco de Dados</h2>

      {/* Status Card */}
      <div style={statusCardStyle(status)}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div>
            <strong style={{ fontSize: '14px' }}>Status da Conex√£o</strong>
            <p style={{ margin: '5px 0 0 0', fontSize: '12px', color: '#666' }}>
              {status === 'conectado' && (
                <>
                  ‚úÖ Conectado como: <code>{config?.usuario}@{config?.servidor}</code>
                  <br/>
                  Config Key: <code style={{ fontSize: '10px' }}>{configKey}</code>
                </>
              )}
              {status === 'desconectado' && '‚ùå Desconectado - Nenhuma configura√ß√£o ativa'}
              {status === 'erro' && `‚ö†Ô∏è Erro: ${erro}`}
            </p>
          </div>
          {status === 'conectado' && (
            <button onClick={handleDesconectar} style={btnDangerStyle}>
              üîå Desconectar
            </button>
          )}
        </div>
      </div>

      {/* Form */}
      <form onSubmit={handleValidar} style={formStyle}>
        <div style={fieldGroupStyle}>
          <label>Servidor SQL Server</label>
          <input
            type="text"
            name="servidor"
            placeholder="ex: localhost ou 192.168.1.10"
            value={formData.servidor}
            onChange={handleChange}
            disabled={carregando || testando}
            style={inputStyle}
          />
          <small style={helpTextStyle}>IP ou nome do servidor SQL Server</small>
        </div>

        <div style={fieldGroupStyle}>
          <label>Banco de Dados</label>
          <input
            type="text"
            name="banco"
            placeholder="ex: PLD"
            value={formData.banco}
            onChange={handleChange}
            disabled={carregando || testando}
            style={inputStyle}
          />
          <small style={helpTextStyle}>Nome do banco de dados PLD</small>
        </div>

        <div style={fieldGroupStyle}>
          <label>Usu√°rio SQL</label>
          <input
            type="text"
            name="usuario"
            placeholder="ex: sa"
            value={formData.usuario}
            onChange={handleChange}
            disabled={carregando || testando}
            style={inputStyle}
          />
          <small style={helpTextStyle}>Usu√°rio de autentica√ß√£o SQL</small>
        </div>

        <div style={fieldGroupStyle}>
          <label>Senha</label>
          <input
            type="password"
            name="senha"
            placeholder="Sua senha"
            value={formData.senha}
            onChange={handleChange}
            disabled={carregando || testando}
            style={inputStyle}
          />
          <small style={helpTextStyle}>Senha do usu√°rio SQL</small>
        </div>

        <div style={buttonGroupStyle}>
          <button
            type="button"
            onClick={handleTestar}
            disabled={carregando || testando}
            style={btnSecondaryStyle}
          >
            {testando ? '‚åõ Testando...' : 'üîç Testar Conex√£o'}
          </button>
          <button
            type="submit"
            disabled={carregando || testando}
            style={btnPrimaryStyle}
          >
            {carregando ? '‚åõ Validando...' : '‚úÖ Validar e Ativar'}
          </button>
        </div>
      </form>

      {/* Resultado do teste */}
      {statusTeste && (
        <div style={resultadoStyle(statusTeste.status)}>
          <strong>{statusTeste.status === 'ok' ? '‚úÖ Sucesso' : '‚ùå Erro'}</strong>
          <p>{statusTeste.mensagem}</p>
          {statusTeste.detalhes && (
            <pre style={{ fontSize: '11px', color: '#666', margin: '10px 0 0 0' }}>
              {JSON.stringify(statusTeste.detalhes, null, 2)}
            </pre>
          )}
        </div>
      )}

      {/* Info Box */}
      <div style={infoBoxStyle}>
        <strong>‚ÑπÔ∏è Como funciona:</strong>
        <ul style={{ margin: '10px 0 0 0', fontSize: '12px', paddingLeft: '20px' }}>
          <li>Configure suas credenciais SQL Server</li>
          <li>Clique "Testar Conex√£o" para validar (opcional)</li>
          <li>Clique "Validar e Ativar" para conectar ao banco</li>
          <li>Uma vez conectado, todas as opera√ß√µes usar√£o essa conex√£o</li>
          <li>Voc√™ pode desconectar e conectar a outro servidor quando quiser</li>
        </ul>
      </div>
    </div>
  );
}

// ===== ESTILOS =====
const containerStyle = {
  padding: '30px',
  backgroundColor: '#f8f9fa',
  minHeight: '100vh'
};

const statusCardStyle = (status) => ({
  padding: '20px',
  marginBottom: '30px',
  borderRadius: '8px',
  border: '2px solid',
  borderColor: status === 'conectado' ? '#10b981' : status === 'erro' ? '#ef4444' : '#d1d5db',
  backgroundColor: status === 'conectado' ? '#ecfdf5' : status === 'erro' ? '#fef2f2' : '#f9fafb'
});

const formStyle = {
  backgroundColor: 'white',
  padding: '20px',
  borderRadius: '8px',
  marginBottom: '20px',
  boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
};

const fieldGroupStyle = {
  marginBottom: '15px'
};

const inputStyle = {
  width: '100%',
  padding: '10px',
  border: '1px solid #d1d5db',
  borderRadius: '4px',
  fontSize: '14px',
  marginTop: '5px',
  boxSizing: 'border-box'
};

const helpTextStyle = {
  display: 'block',
  marginTop: '4px',
  color: '#6b7280',
  fontSize: '11px'
};

const buttonGroupStyle = {
  display: 'flex',
  gap: '10px',
  marginTop: '20px'
};

const btnPrimaryStyle = {
  flex: 1,
  padding: '10px',
  backgroundColor: '#007bff',
  color: 'white',
  border: 'none',
  borderRadius: '4px',
  fontSize: '14px',
  fontWeight: 'bold',
  cursor: 'pointer',
  transition: 'background-color 0.2s'
};

const btnSecondaryStyle = {
  flex: 1,
  padding: '10px',
  backgroundColor: '#6c757d',
  color: 'white',
  border: 'none',
  borderRadius: '4px',
  fontSize: '14px',
  fontWeight: 'bold',
  cursor: 'pointer'
};

const btnDangerStyle = {
  padding: '8px 12px',
  backgroundColor: '#ef4444',
  color: 'white',
  border: 'none',
  borderRadius: '4px',
  fontSize: '12px',
  cursor: 'pointer'
};

const resultadoStyle = (status) => ({
  padding: '15px',
  marginBottom: '20px',
  borderRadius: '8px',
  backgroundColor: status === 'ok' ? '#ecfdf5' : '#fef2f2',
  border: `1px solid ${status === 'ok' ? '#10b981' : '#ef4444'}`,
  color: status === 'ok' ? '#065f46' : '#7f1d1d'
});

const infoBoxStyle = {
  padding: '15px',
  backgroundColor: '#eff6ff',
  border: '1px solid #93c5fd',
  borderRadius: '8px',
  fontSize: '13px',
  color: '#1e40af'
};
